<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Strick van Linschoten">
<meta name="dcterms.date" content="2024-06-15">
<meta name="description" content="I finetuned my first LLM(s) for the task of extracting structured data from ISAF press releases. Initial tests suggest that it worked pretty well out of the box.">

<title>Finetuning my first LLM(s) for structured data extraction with axolotl – Alex Strick van Linschoten</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<script defer="" data-domain="alexstrick.com" src="https://plausible.io/js/script.js"></script>


<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="../styles/technical.css">
<meta property="og:title" content="Finetuning my first LLM(s) for structured data extraction with axolotl – Alex Strick van Linschoten">
<meta property="og:description" content="I finetuned my first LLM(s) for the task of extracting structured data from ISAF press releases. Initial tests suggest that it worked pretty well out of the box.">
<meta property="og:image" content="https://alexstrick.com/posts/images/first-finetune.png">
<meta property="og:site_name" content="Alex Strick van Linschoten">
<meta property="og:image:height" content="752">
<meta property="og:image:width" content="931">
<meta name="twitter:title" content="Finetuning my first LLM(s) for structured data extraction with axolotl – Alex Strick van Linschoten">
<meta name="twitter:description" content="I finetuned my first LLM(s) for the task of extracting structured data from ISAF press releases. Initial tests suggest that it worked pretty well out of the box.">
<meta name="twitter:image" content="https://alexstrick.com/posts/images/first-finetune.png">
<meta name="twitter:creator" content="@strickvl">
<meta name="twitter:image-height" content="752">
<meta name="twitter:image-width" content="931">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed technical-page quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Alex Strick van Linschoten</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../technical.html"> 
<span class="menu-text">Technical</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../personal.html"> 
<span class="menu-text">Personal</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../all.html"> 
<span class="menu-text">All</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../til.html"> 
<span class="menu-text">TIL</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/strickvl"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://sigmoid.social/web/@alexstrick"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/strickvl"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-rss" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">RSS</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-rss">    
        <li>
    <a class="dropdown-item" href="../technical.xml">
 <span class="dropdown-text">Technical RSS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../personal.xml">
 <span class="dropdown-text">Personal RSS</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preparing-data-for-finetuning" id="toc-preparing-data-for-finetuning" class="nav-link active" data-scroll-target="#preparing-data-for-finetuning">Preparing data for finetuning</a>
  <ul class="collapse">
  <li><a href="#loading-the-datasets" id="toc-loading-the-datasets" class="nav-link" data-scroll-target="#loading-the-datasets">Loading the datasets</a></li>
  <li><a href="#setting-up-our-pydantic-models-with-validation" id="toc-setting-up-our-pydantic-models-with-validation" class="nav-link" data-scroll-target="#setting-up-our-pydantic-models-with-validation">Setting up our Pydantic models with validation</a></li>
  </ul></li>
  <li><a href="#writing-our-data-as-jsonl" id="toc-writing-our-data-as-jsonl" class="nav-link" data-scroll-target="#writing-our-data-as-jsonl">Writing our data as JSONL</a>
  <ul class="collapse">
  <li><a href="#writing-alpaca-sharegpt-format-jsonl" id="toc-writing-alpaca-sharegpt-format-jsonl" class="nav-link" data-scroll-target="#writing-alpaca-sharegpt-format-jsonl">Writing Alpaca / ShareGPT format JSONL</a></li>
  <li><a href="#writing-template-free-json" id="toc-writing-template-free-json" class="nav-link" data-scroll-target="#writing-template-free-json">Writing Template-Free JSON</a></li>
  </ul></li>
  <li><a href="#finetuning-our-model" id="toc-finetuning-our-model" class="nav-link" data-scroll-target="#finetuning-our-model">Finetuning our model</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Finetuning my first LLM(s) for structured data extraction with axolotl</h1>
  <div class="quarto-categories">
    <div class="quarto-category">nlp</div>
    <div class="quarto-category">afghanistan</div>
    <div class="quarto-category">llms</div>
    <div class="quarto-category">miniproject</div>
    <div class="quarto-category">finetuning</div>
    <div class="quarto-category">isafpr</div>
  </div>
  </div>

<div>
  <div class="description">
    I finetuned my first LLM(s) for the task of extracting structured data from ISAF press releases. Initial tests suggest that it worked pretty well out of the box.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex Strick van Linschoten </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 15, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>We previously <a href="https://mlops.systems/posts/2024-06-03-isafpr-evaluating-baseline.html">looked into how well</a> the top LLMs could do when given press releases and asked to extract structured data from them. I was glad that this clearly wasn’t a task they struggled with, but it was by no means a simple task for them and some basic evaluations that I performed showed that there was room for improvement.</p>
<p>Since writing that post I also heard from readers to say that perhaps I wasn’t using the OpenAI API in a way that would get the best results. In particular, function calling would give a better accuracy over the raw prompting that I was using. I’ll probably return to that in a separate post when I compare how well we’re doing with finetuning.</p>
<p>As a quick reminder, we’re hoping to create something that will allow us to go from an unstructured text (a press release, in our case) to a structured output that accurately extracts certain pieces of metadata from the text. Please give <a href="https://mlops.systems/posts/2024-06-02-isafpr-prompting-baseline.html">the first post</a> in the series a read if you want more of the context of what we’re doing.</p>
<p>This blogpost will be about my first finetune(s) of some models and I’ll showcase how I got the data ready and then some observations about the finetuning process in general.</p>
<section id="preparing-data-for-finetuning" class="level1">
<h1>Preparing data for finetuning</h1>
<p>In my previous posts I’ve already showed how I converted my dataset into <a href="https://github.com/pydantic/pydantic">Pydantic</a> models. This helps ensure a uniformity to the data I’ll be using in my finetuning. We’ll actually want to convert the labelled data into JSON strings from the Pydantic models, but as an interim datastructure Pydantic is useful for the validation.</p>
<section id="loading-the-datasets" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-datasets">Loading the datasets</h2>
<div id="cell-2" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loadthe dataset</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>train_dataset <span class="op">=</span> load_dataset(<span class="st">"strickvl/isafpressreleases"</span>, split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>test_dataset <span class="op">=</span> load_dataset(<span class="st">"strickvl/isafpressreleases"</span>, split<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the dataset to a pandas DataFrame</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(train_dataset)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(test_dataset)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"4b0282eaaa0f458cbeeaf3eb2eae9d5d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"34595eba125f4fa8b243759c8392f415","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"97c9b72c11614da2aa24d90dc13f3d9c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bd396a8ddbea43febdd1e2ca132890c1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3aad0332bcc54088872aa9de9c7acc7c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-3" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>train_dataset</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Dataset({
    features: ['name', 'eventrefnumber', 'text', 'StartDate', 'eventtype', 'province', 'citydistrict', 'village', 'targetgroup', 'commander', 'position', 'minkilled', 'mincaptured', 'capturedcharacterisation', 'killedcharacterisation', 'killq', 'captureq', 'killcaptureraid', 'airstrike', 'noshotsfired', 'dataprocessed', 'flagged', 'glossarymeta', 'minleaderskilled', 'minfacilitatorskilled', 'minleaderscaptured', 'minfacilitatorscaptured', 'leaderq'],
    num_rows: 4098
})</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>test_dataset</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Dataset({
    features: ['name', 'eventrefnumber', 'text', 'StartDate', 'eventtype', 'province', 'citydistrict', 'village', 'targetgroup', 'commander', 'position', 'minkilled', 'mincaptured', 'capturedcharacterisation', 'killedcharacterisation', 'killq', 'captureq', 'killcaptureraid', 'airstrike', 'noshotsfired', 'dataprocessed', 'flagged', 'glossarymeta', 'minleaderskilled', 'minfacilitatorskilled', 'minleaderscaptured', 'minfacilitatorscaptured', 'leaderq'],
    num_rows: 724
})</code></pre>
</div>
</div>
<p>We have 4098 training examples and 724 test examples. This seems a good split to me. I experimented a bit with the exact split and found that 15% seemed like a good compromise. We want enough data to get a good evaluation, but we also want to give our model enough examples to learn. In the course people were frequently talking about somewhere in the order of mid hundreds to low thousands as being the sweet spot, so I hope I’m firmly in that range.</p>
<p>It’s also worth reflecting that I’m lucky that I have such a large clean dataset to work with. In a later project I’d like to try working with much less and slowly building up something more complex since that’s a skill in and of itself.</p>
</section>
<section id="setting-up-our-pydantic-models-with-validation" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-our-pydantic-models-with-validation">Setting up our Pydantic models with validation</h2>
<p>There’s a decent amount of code in the next cell, and definitely read the previous posts to understand what all the pieces are about, but in a nutshell we’re setting ourselves up to extract structured data from the text. This Pydantic model is what will hold the data we’re interested in.</p>
<div id="cell-6" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Set, Annotated, Optional</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, validator, ValidationInfo</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EventType(<span class="bu">str</span>, Enum):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    airstrike <span class="op">=</span> <span class="st">"airstrike"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    detention <span class="op">=</span> <span class="st">"detention"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    captureandkill <span class="op">=</span> <span class="st">"captureandkill"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    insurgentskilled <span class="op">=</span> <span class="st">"insurgentskilled"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    exchangeoffire <span class="op">=</span> <span class="st">"exchangeoffire"</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    civiliancasualty <span class="op">=</span> <span class="st">"civiliancasualty"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Province(<span class="bu">str</span>, Enum):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    badakhshan <span class="op">=</span> <span class="st">"badakhshan"</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    badghis <span class="op">=</span> <span class="st">"badghis"</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    baghlan <span class="op">=</span> <span class="st">"baghlan"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    balkh <span class="op">=</span> <span class="st">"balkh"</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    bamyan <span class="op">=</span> <span class="st">"bamyan"</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    day_kundi <span class="op">=</span> <span class="st">"day_kundi"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    farah <span class="op">=</span> <span class="st">"farah"</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    faryab <span class="op">=</span> <span class="st">"faryab"</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    ghazni <span class="op">=</span> <span class="st">"ghazni"</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    ghor <span class="op">=</span> <span class="st">"ghor"</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    helmand <span class="op">=</span> <span class="st">"helmand"</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    herat <span class="op">=</span> <span class="st">"herat"</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    jowzjan <span class="op">=</span> <span class="st">"jowzjan"</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    kabul <span class="op">=</span> <span class="st">"kabul"</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    kandahar <span class="op">=</span> <span class="st">"kandahar"</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    kapisa <span class="op">=</span> <span class="st">"kapisa"</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    khost <span class="op">=</span> <span class="st">"khost"</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    kunar <span class="op">=</span> <span class="st">"kunar"</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    kunduz <span class="op">=</span> <span class="st">"kunduz"</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    laghman <span class="op">=</span> <span class="st">"laghman"</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    logar <span class="op">=</span> <span class="st">"logar"</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    nangarhar <span class="op">=</span> <span class="st">"nangarhar"</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    nimroz <span class="op">=</span> <span class="st">"nimroz"</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    nuristan <span class="op">=</span> <span class="st">"nuristan"</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    paktya <span class="op">=</span> <span class="st">"paktya"</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    paktika <span class="op">=</span> <span class="st">"paktika"</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    panjshir <span class="op">=</span> <span class="st">"panjshir"</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    parwan <span class="op">=</span> <span class="st">"parwan"</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    samangan <span class="op">=</span> <span class="st">"samangan"</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    sar_e_pul <span class="op">=</span> <span class="st">"sar_e_pul"</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    takhar <span class="op">=</span> <span class="st">"takhar"</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    uruzgan <span class="op">=</span> <span class="st">"uruzgan"</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    wardak <span class="op">=</span> <span class="st">"wardak"</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    zabul <span class="op">=</span> <span class="st">"zabul"</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TargetGroup(<span class="bu">str</span>, Enum):</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    taliban <span class="op">=</span> <span class="st">"taliban"</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    haqqani <span class="op">=</span> <span class="st">"haqqani"</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    criminals <span class="op">=</span> <span class="st">"criminals"</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    aq <span class="op">=</span> <span class="st">"aq"</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    hig <span class="op">=</span> <span class="st">"hig"</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    let <span class="op">=</span> <span class="st">"let"</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    imu <span class="op">=</span> <span class="st">"imu"</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    judq <span class="op">=</span> <span class="st">"judq"</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    iju <span class="op">=</span> <span class="st">"iju"</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    hik <span class="op">=</span> <span class="st">"hik"</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    ttp <span class="op">=</span> <span class="st">"ttp"</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    other <span class="op">=</span> <span class="st">"other"</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_event_type(value: <span class="bu">str</span>):</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    valid_values <span class="op">=</span> [</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"airstrike"</span>,</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"detention"</span>,</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"captureandkill"</span>,</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"insurgentskilled"</span>,</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"exchangeoffire"</span>,</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"civiliancasualty"</span>,</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value.lower() <span class="kw">not</span> <span class="kw">in</span> valid_values:</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"other"</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value.lower()</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_province(value: <span class="bu">str</span>):</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    valid_values <span class="op">=</span> [</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"badakhshan"</span>,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"badghis"</span>,</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"baghlan"</span>,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">"balkh"</span>,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bamyan"</span>,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"day_kundi"</span>,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"farah"</span>,</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">"faryab"</span>,</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ghazni"</span>,</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ghor"</span>,</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">"helmand"</span>,</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"herat"</span>,</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>        <span class="st">"jowzjan"</span>,</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kabul"</span>,</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kandahar"</span>,</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kapisa"</span>,</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">"khost"</span>,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kunar"</span>,</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kunduz"</span>,</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">"laghman"</span>,</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">"logar"</span>,</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nangarhar"</span>,</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nimroz"</span>,</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nuristan"</span>,</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"paktya"</span>,</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">"paktika"</span>,</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">"panjshir"</span>,</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">"parwan"</span>,</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"samangan"</span>,</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sar_e_pul"</span>,</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"takhar"</span>,</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">"uruzgan"</span>,</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wardak"</span>,</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"zabul"</span>,</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value.lower() <span class="kw">not</span> <span class="kw">in</span> valid_values:</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"other"</span></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value.lower()</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_target_group(value: <span class="bu">str</span>):</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    valid_values <span class="op">=</span> [</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">"taliban"</span>,</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">"haqqani"</span>,</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">"criminals"</span>,</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">"aq"</span>,</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hig"</span>,</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">"let"</span>,</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">"imu"</span>,</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">"judq"</span>,</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">"iju"</span>,</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hik"</span>,</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ttp"</span>,</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">"other"</span>,</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value.lower() <span class="kw">not</span> <span class="kw">in</span> valid_values:</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"other"</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value.lower()</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IsafEvent(BaseModel):</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"A title or name for the event which summarises the event as a headline"</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    text: Optional[<span class="bu">str</span>] <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The full text of the press release"</span>)</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>    start_date: date <span class="op">=</span> Field(</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The start date of the event in YYYY-MM-DD format"</span></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>    event_type: Set[Annotated[<span class="bu">str</span>, Field(validator<span class="op">=</span>validate_event_type)]] <span class="op">=</span> Field(</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The event type. Can be multiple types."</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>    province: Set[Annotated[<span class="bu">str</span>, Field(validator<span class="op">=</span>validate_province)]] <span class="op">=</span> Field(</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The province in which the event occurred. Can be multiple provinces."</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>    target_group: Set[Annotated[<span class="bu">str</span>, Field(validator<span class="op">=</span>validate_target_group)]] <span class="op">=</span> Field(</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The group that was targetted during the event. Can be multiple groups."</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>    min_killed: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of people killed during the event"</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>    min_captured: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of people captured during the event"</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>    killq: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether someone was killed or not during the event"</span></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>    captureq: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether someone was captured or not during the event"</span></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>    killcaptureraid: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether the event was a so-called 'kill-capture raid'."</span></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>    airstrike: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether an airstrike was used during the event"</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>    noshotsfired: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether no shots were fired during the event"</span></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>    min_leaders_killed: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of leaders killed during the event"</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>    min_leaders_captured: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of leaders captured during the event"</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Config:</span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>        arbitrary_types_allowed <span class="op">=</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Here’s what a couple of examples of our training data looks like as Pydantic models when we pass them in:</p>
<div id="cell-8" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>events: List[IsafEvent] <span class="op">=</span> []</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">list</span>(train_df.iterrows()):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    event_types <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        eventtype.strip().lower() <span class="cf">for</span> eventtype <span class="kw">in</span> row[<span class="st">"eventtype"</span>].split(<span class="st">","</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    provinces <span class="op">=</span> <span class="bu">set</span>(province.strip().lower() <span class="cf">for</span> province <span class="kw">in</span> row[<span class="st">"province"</span>].split(<span class="st">","</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    target_groups <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        target_group.strip().lower() <span class="cf">for</span> target_group <span class="kw">in</span> row[<span class="st">"targetgroup"</span>].split(<span class="st">","</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    events.append(</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        IsafEvent(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span>row[<span class="st">"name"</span>],</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>row[<span class="st">"text"</span>],</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            start_date<span class="op">=</span>row[<span class="st">"StartDate"</span>].to_pydatetime().date(),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            event_type<span class="op">=</span>event_types,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            province<span class="op">=</span>provinces,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            target_group<span class="op">=</span>target_groups,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            min_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minkilled"</span>]),</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            min_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"mincaptured"</span>]),</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            killq<span class="op">=</span>row[<span class="st">"killq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            captureq<span class="op">=</span>row[<span class="st">"captureq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            killcaptureraid<span class="op">=</span>row[<span class="st">"killcaptureraid"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            airstrike<span class="op">=</span>row[<span class="st">"airstrike"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            noshotsfired<span class="op">=</span>row[<span class="st">"noshotsfired"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            min_leaders_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderskilled"</span>]),</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            min_leaders_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderscaptured"</span>]),</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(events[:<span class="dv">2</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
        <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Several insurgents killed in Helmand'</span>,
        <span style="color: #808000; text-decoration-color: #808000">text</span>=<span style="color: #008000; text-decoration-color: #008000">'ISAF Joint Command Evening Operational Update Feb. 19, 2011\nISAF Joint Command - </span>
<span style="color: #008000; text-decoration-color: #008000">Afghanistan\u20282011-02-S-143\u2028For Immediate Release \u2028\u2028KABUL, Afghanistan (Feb. 19)\u2028\u2028ISAF </span>
<span style="color: #008000; text-decoration-color: #008000">service members at a compound in Sangin district, Helmand province observed numerous insurgents north and south of </span>
<span style="color: #008000; text-decoration-color: #008000">their position talking on radios today. After gaining positive identification of the insurgent positions, the </span>
<span style="color: #008000; text-decoration-color: #008000">coalition troops engaged, killing several insurgents. Later, the ISAF troops observed more insurgents positioning </span>
<span style="color: #008000; text-decoration-color: #008000">in the area with weapons. After positive identification, coalition forces continued firing on the various insurgent</span>
<span style="color: #008000; text-decoration-color: #008000">positions, resulting in several more insurgents being killed.'</span>,
        <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2011</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span><span style="font-weight: bold">)</span>,
        <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'insurgentskilled'</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">province</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'helmand'</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">''</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
        <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
        <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
    <span style="font-weight: bold">)</span>,
    <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
        <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Force Continues Targeting Haqqani Leadership'</span>,
        <span style="color: #808000; text-decoration-color: #808000">text</span>=<span style="color: #008000; text-decoration-color: #008000">'Force Continues Targeting Haqqani Leadership\nISAF Joint Command - Afghanistan\u20282010-09-CA-211 </span>
<span style="color: #008000; text-decoration-color: #008000">For Immediate Release\u2028Download PDF \u2028\u2028\u2028\xa0KABUL, Afghanistan (Sept. 20) - An Afghan and </span>
<span style="color: #008000; text-decoration-color: #008000">coalition security force detained two insurgents, including a Haqqani Network sub-commander operating in Khost </span>
<span style="color: #008000; text-decoration-color: #008000">province, Sunday. \u2028\u2028The commander coordinated and conducted attacks on coalition forces operating in the </span>
<span style="color: #008000; text-decoration-color: #008000">province and was formerly active in Kabul. \u2028\u2028Intelligence reports led the security force to a compound </span>
<span style="color: #008000; text-decoration-color: #008000">northwest of Khost City to search for the commander. Afghan forces called for all occupants to exit the buildings </span>
<span style="color: #008000; text-decoration-color: #008000">peacefully and then the combined force cleared and secured the compound. During the clearance, an armed individual </span>
<span style="color: #008000; text-decoration-color: #008000">came out of an adjacent building toward the security force. The forced engaged the individual and killed him. </span>
<span style="color: #008000; text-decoration-color: #008000">\u2028\u2028After the area was secure, the security force questioned the residents at the scene and detained the </span>
<span style="color: #008000; text-decoration-color: #008000">commander and one of his associates. The security force also found multiple automatic weapons, magazines and </span>
<span style="color: #008000; text-decoration-color: #008000">grenades at the scene. \u2028\u2028The assault force protected the women and children throughout the search.'</span>,
        <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2010</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span><span style="font-weight: bold">)</span>,
        <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'captureandkill'</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">province</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'haqqani'</span><span style="font-weight: bold">}</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
        <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
        <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
        <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
        <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
        <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
    <span style="font-weight: bold">)</span>
<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<p>So this is data that we’ve already labelled. You can see the text that we’ll provide as input to our model, and then you can see the various fields that we’re hoping our model can learn to extract. As a JSON string, the prediction that we’re hoping our model will output would look like this:</p>
<div id="cell-10" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>json_str <span class="op">=</span> events[<span class="dv">0</span>].model_dump_json(exclude<span class="op">=</span>{<span class="st">"text"</span>})</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json_str)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"name"</span>:<span style="color: #008000; text-decoration-color: #008000">"Several insurgents killed in </span>
<span style="color: #008000; text-decoration-color: #008000">Helmand"</span>,<span style="color: #008000; text-decoration-color: #008000">"start_date"</span>:<span style="color: #008000; text-decoration-color: #008000">"2011-02-18"</span>,<span style="color: #008000; text-decoration-color: #008000">"event_type"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">"insurgentskilled"</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"province"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">"helmand"</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"target_group"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">""</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"mi</span>
<span style="color: #008000; text-decoration-color: #008000">n_killed"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,<span style="color: #008000; text-decoration-color: #008000">"min_captured"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008000; text-decoration-color: #008000">"killq"</span>:true,<span style="color: #008000; text-decoration-color: #008000">"captureq"</span>:false,<span style="color: #008000; text-decoration-color: #008000">"killcaptureraid"</span>:false,<span style="color: #008000; text-decoration-color: #008000">"airstrike"</span>:false,<span style="color: #008000; text-decoration-color: #008000">"noshotsfired"</span>
:false,<span style="color: #008000; text-decoration-color: #008000">"min_leaders_killed"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008000; text-decoration-color: #008000">"min_leaders_captured"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>If you wish to view more examples of the data, I <a href="https://huggingface.co/datasets/strickvl/isaf_press_releases_ft">created an interim dataset</a> which I uploaded to the Hugging Face Hub, but it’s not completely in the required form for finetuning so I’ll just <a href="https://huggingface.co/datasets/strickvl/isaf_press_releases_ft">link to it here</a> and you can explore it to see the pairings of input and output if you’re interested.</p>
</section>
</section>
<section id="writing-our-data-as-jsonl" class="level1">
<h1>Writing our data as JSONL</h1>
<p><code>axolotl</code> likes its training data as a JSONL file, so that’s what we’ll write to disk to make training possible. We’ll write two different files, one for training and another for evaluation. <code>axolotl</code> actually handles making a train-test split for us, so we’ll actually use the test set as a true held out evaluation set for use later on.</p>
<p>The data needs to be formatted in a certain way for our model to learn to output in JSON format. I’ll show two different ways of doing this below, since I found the process a bit confusing and the first time I did it in a way that technically <em>works</em> but might not be the best.</p>
<section id="writing-alpaca-sharegpt-format-jsonl" class="level2">
<h2 class="anchored" data-anchor-id="writing-alpaca-sharegpt-format-jsonl">Writing Alpaca / ShareGPT format JSONL</h2>
<p>In the course, Hamel shared an example from work he’d done with Honeycomb to output in a particular format. He <a href="https://github.com/parlance-labs/ftcourse/blob/master/04_prep_data.ipynb">shared his notebooks</a> and I found this useful as an initial example to move forward with. He uses the ShareGPT template to format his data, and I followed that format for my data. This looks something like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"conversations"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"from"</span><span class="fu">:</span> <span class="st">"system"</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"Honeycomb is an observability platform that allows you to write queries to inspect trace data. You are an assistant that takes a natural language query (NLQ) and a list of valid columns and produce a Honeycomb query."</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"from"</span><span class="fu">:</span> <span class="st">"human"</span><span class="fu">,</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">NLQ: </span><span class="ch">\"</span><span class="st">group by HTTP method</span><span class="ch">\"\n\n</span><span class="st">Columns: ['query_string_num_tokens', 'query_string_length', 'data_queries', 'http.target', 'task.id', 'trace_root.http.target', 'topic', 'http.host', 'total_hits', 'db.user', 'domain_types', 'db.name', 'graphql.document', 'history', 'http.scheme', 'http.method', 'frontend.version', 'disposition_for_dBVVysC8x4Ymwg9rtjMckgw9', 'db.system', 'event_name', 'organization', 'auth.logout', 'organizations', 'name', 'net.transport', 'db.operation', 'disposition_for_UvsPPBVUn9FDuzDjsjYCqopq', 'disposition_for_1RUGSd7GdnP5tuKdgqBRZUm2', 'process.pid', 'disposition_for_6uyAoBc3PuvEcTTPFgPM3Rtk', 'exception.stacktrace', 'data_ingestion_individuals_count', 'disposition_for_qrnUBUz8YBfNX7Liekq6nKi3', 'task_type.type', 'disposition_for_JQDNbuUdaQcEbEwQNxUbV5EF', 'disposition_for_rAcWoXfbHw4eWoJFH4ZcY8ue', 'disposition_for_eShqQoC9jUi9VQBidpp2oXHP', 'parent_name', 'template', 'graphql.operation.name', 'span.num_links', 'disposition_for_kNSPtvsCWkDoEyFP2QE6VPmQ', 'disposition_for_UUqf9L1qkFxDNEvcgsVMA2yy', 'disposition_for_vwbbN76HZ7uitLubvkUjPFQE', 'disposition_for_aAto1pGrdF5RunpSX8sY5hvn', 'disposition_for_UbKCMdnkPQ6TuHrfdBo5juZu', 'disposition_for_QfrvmoHxSgLPJXPKZCrZfGo8', 'disposition_for_NoKSSruBRCX6UG28PzmkybUd', 'disposition_for_UZAqvZ5XVBZjKKWuMeRkRayS', 'organization_token', 'duration_ms', 'trace.parent_id', 'db.statement', 'exception.message', 'error', 'service.name', 'http.status_code', 'http.route']"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"from"</span><span class="fu">:</span> <span class="st">"gpt"</span><span class="fu">,</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"value"</span><span class="fu">:</span> <span class="st">"</span><span class="ch">\n</span><span class="st">{</span><span class="ch">\"</span><span class="st">breakdowns</span><span class="ch">\"</span><span class="st">: [</span><span class="ch">\"</span><span class="st">http.method</span><span class="ch">\"</span><span class="st">], </span><span class="ch">\"</span><span class="st">calculations</span><span class="ch">\"</span><span class="st">: [{</span><span class="ch">\"</span><span class="st">op</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">COUNT</span><span class="ch">\"</span><span class="st">}], </span><span class="ch">\"</span><span class="st">time_range</span><span class="ch">\"</span><span class="st">: 7200}"</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>You can see that a single entry is part of a <code>conversations</code> key, and then you have a series of messages with <code>system</code>, <code>human</code> and <code>gpt</code> roles. I followed this closely for my data, but with a base model I’m pretty sure this isn’t strictly necessary. (The second option is what I’ll show a bit later).</p>
<p>Writing the data is a case of wrangling the data so it fits the format above, and doing it separately for our train and test datasets. You’ll note that in the system call I stuff in the event types, provinces and target groups as a way to provide some context to the model. This was something that Hamel did in his example.</p>
<div id="cell-12" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(<span class="st">"strickvl/isafpressreleases"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>train_target_file_path <span class="op">=</span> <span class="st">"../data/sharegpt_isaf_press_releases_ft_train.jsonl"</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>test_target_file_path <span class="op">=</span> <span class="st">"../data/sharegpt_isaf_press_releases_ft_test.jsonl"</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_data_to_jsonl(df: pd.DataFrame, target_file_path: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    events: List[IsafEvent] <span class="op">=</span> []</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">list</span>(df.iterrows()):</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        event_types <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            eventtype.strip().lower() <span class="cf">for</span> eventtype <span class="kw">in</span> row[<span class="st">"eventtype"</span>].split(<span class="st">","</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        provinces <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            province.strip().lower() <span class="cf">for</span> province <span class="kw">in</span> row[<span class="st">"province"</span>].split(<span class="st">","</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        target_groups <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            target_group.strip().lower()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> target_group <span class="kw">in</span> row[<span class="st">"targetgroup"</span>].split(<span class="st">","</span>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        events.append(</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            IsafEvent(</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span>row[<span class="st">"name"</span>],</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span>row[<span class="st">"text"</span>],</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                start_date<span class="op">=</span>row[<span class="st">"StartDate"</span>].to_pydatetime().date(),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                event_type<span class="op">=</span>event_types,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                province<span class="op">=</span>provinces,</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                target_group<span class="op">=</span>target_groups,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                min_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minkilled"</span>]),</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                min_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"mincaptured"</span>]),</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                killq<span class="op">=</span>row[<span class="st">"killq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                captureq<span class="op">=</span>row[<span class="st">"captureq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                killcaptureraid<span class="op">=</span>row[<span class="st">"killcaptureraid"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                airstrike<span class="op">=</span>row[<span class="st">"airstrike"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                noshotsfired<span class="op">=</span>row[<span class="st">"noshotsfired"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                min_leaders_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderskilled"</span>]),</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>                min_leaders_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderscaptured"</span>]),</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    processed_data <span class="op">=</span> [</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">"conversations"</span>: [</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"from"</span>: <span class="st">"system"</span>,</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"value"</span>: <span class="st">"You are an expert at identifying events in a press release. You are precise and always make sure you are correct, drawing inference from the text of the press release. event_types = ['airstrike', 'detention', 'captureandkill', 'insurgentskilled', 'exchangeoffire', 'civiliancasualty'], provinces = ['badakhshan', 'badghis', 'baghlan', 'balkh', 'bamyan', 'day_kundi', 'farah', 'faryab', 'ghazni', 'ghor', 'helmand', 'herat', 'jowzjan', 'kabul', 'kandahar', 'kapisa', 'khost', 'kunar', 'kunduz', 'laghman', 'logar', 'nangarhar', 'nimroz', 'nuristan', 'paktya', 'paktika', 'panjshir', 'parwan', 'samangan', 'sar_e_pul', 'takhar', 'uruzgan', 'wardak', 'zabul'], target_groups = ['taliban', 'haqqani', 'criminals', 'aq', 'hig', 'let', 'imu', 'judq', 'iju', 'hik', 'ttp', 'other']"</span>,</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"from"</span>: <span class="st">"human"</span>, <span class="st">"value"</span>: <span class="ss">f"PRESS RELEASE TEXT: </span><span class="sc">{</span>event<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>},</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"from"</span>: <span class="st">"gpt"</span>, <span class="st">"value"</span>: <span class="ss">f"</span><span class="sc">{</span>event<span class="sc">.</span>model_dump_json(exclude<span class="op">=</span>{<span class="st">'text'</span>})<span class="sc">}</span><span class="ss">"</span>},</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> event <span class="kw">in</span> events</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the processed data to a JSONL file</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    os.makedirs(os.path.dirname(target_file_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(target_file_path, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> processed_data:</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>            f.write(json.dumps(item) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the data to disk</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> pd.DataFrame(dataset[<span class="st">"train"</span>])</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame(dataset[<span class="st">"test"</span>])</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>write_data_to_jsonl(train_df, train_target_file_path)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>write_data_to_jsonl(test_df, test_target_file_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The first line of the training file looks like this now:</p>
<div id="cell-14" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(train_target_file_path, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(f.readline())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"conversations"</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">"from"</span>: <span style="color: #008000; text-decoration-color: #008000">"system"</span>, <span style="color: #008000; text-decoration-color: #008000">"value"</span>: <span style="color: #008000; text-decoration-color: #008000">"You are an expert at identifying events in a press release. You are</span>
<span style="color: #008000; text-decoration-color: #008000">precise and always make sure you are correct, drawing inference from the text of the press release. event_types = </span>
<span style="color: #008000; text-decoration-color: #008000">['airstrike', 'detention', 'captureandkill', 'insurgentskilled', 'exchangeoffire', 'civiliancasualty'], provinces =</span>
<span style="color: #008000; text-decoration-color: #008000">['badakhshan', 'badghis', 'baghlan', 'balkh', 'bamyan', 'day_kundi', 'farah', 'faryab', 'ghazni', 'ghor', </span>
<span style="color: #008000; text-decoration-color: #008000">'helmand', 'herat', 'jowzjan', 'kabul', 'kandahar', 'kapisa', 'khost', 'kunar', 'kunduz', 'laghman', 'logar', </span>
<span style="color: #008000; text-decoration-color: #008000">'nangarhar', 'nimroz', 'nuristan', 'paktya', 'paktika', 'panjshir', 'parwan', 'samangan', 'sar_e_pul', 'takhar', </span>
<span style="color: #008000; text-decoration-color: #008000">'uruzgan', 'wardak', 'zabul'], target_groups = ['taliban', 'haqqani', 'criminals', 'aq', 'hig', 'let', 'imu', </span>
<span style="color: #008000; text-decoration-color: #008000">'judq', 'iju', 'hik', 'ttp', 'other']"</span><span style="font-weight: bold">}</span>, <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"from"</span>: <span style="color: #008000; text-decoration-color: #008000">"human"</span>, <span style="color: #008000; text-decoration-color: #008000">"value"</span>: <span style="color: #008000; text-decoration-color: #008000">"PRESS RELEASE TEXT: ISAF Joint Command Evening</span>
<span style="color: #008000; text-decoration-color: #008000">Operational Update Feb. 19, 2011\nISAF Joint Command - Afghanistan\u20282011-02-S-143\u2028For Immediate Release </span>
<span style="color: #008000; text-decoration-color: #008000">\u2028\u2028KABUL, Afghanistan (Feb. 19)\u2028\u2028ISAF service members at a compound in Sangin district, Helmand </span>
<span style="color: #008000; text-decoration-color: #008000">province observed numerous insurgents north and south of their position talking on radios today. After gaining </span>
<span style="color: #008000; text-decoration-color: #008000">positive identification of the insurgent positions, the coalition troops engaged, killing several insurgents. </span>
<span style="color: #008000; text-decoration-color: #008000">Later, the ISAF troops observed more insurgents positioning in the area with weapons. After positive </span>
<span style="color: #008000; text-decoration-color: #008000">identification, coalition forces continued firing on the various insurgent positions, resulting in several more </span>
<span style="color: #008000; text-decoration-color: #008000">insurgents being killed."</span><span style="font-weight: bold">}</span>, <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"from"</span>: <span style="color: #008000; text-decoration-color: #008000">"gpt"</span>, <span style="color: #008000; text-decoration-color: #008000">"value"</span>: <span style="color: #008000; text-decoration-color: #008000">"{\"name\":\"Several insurgents killed in </span>
<span style="color: #008000; text-decoration-color: #008000">Helmand\",\"start_date\":\"2011-02-18\",\"event_type\":[\"insurgentskilled\"],\"province\":[\"helmand\"],\"target_g</span>
<span style="color: #008000; text-decoration-color: #008000">roup\":[\"\"],\"min_killed\":6,\"min_captured\":0,\"killq\":true,\"captureq\":false,\"killcaptureraid\":false,\"air</span>
<span style="color: #008000; text-decoration-color: #008000">strike\":false,\"noshotsfired\":false,\"min_leaders_killed\":0,\"min_leaders_captured\":0}"</span><span style="font-weight: bold">}]}</span>

</pre>
</div>
</div>
</section>
<section id="writing-template-free-json" class="level2">
<h2 class="anchored" data-anchor-id="writing-template-free-json">Writing Template-Free JSON</h2>
<p>Another option available to us, especially if we are finetuning a base LLM (as opposed to one that has been instruction-tuned), is to write our data in a different format. Hamel’s <a href="https://hamel.dev/notes/llm/finetuning/09_template_free.html">written a guide for this on his blog</a> and that has also been absorbed into the official <code>axolotl</code> documentation, so <a href="https://hamel.dev/notes/llm/finetuning/09_template_free.html">read the blog</a> if you want more information.</p>
<p>The basic idea is that instead of following a format like the one above, we can essentially create our own that’s custom to our own needs. You want this kind of freedom because to follow one of the standard templates is sometimes to shoot yourself in the food with artifacts of those templates that you don’t need in your output.</p>
<p>The key is to specify <code>train_on_inputs</code> as false in our <code>axolotl</code> config which will allow us to mask certain segments of our input data. This means that our model won’t learn the inputs but only the outputs (which we’ll specify).</p>
<p>All that we have to do is set up the JSONL output in a way that makes sense for our use case:</p>
<div id="cell-16" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>template_free_train_target_file_path <span class="op">=</span> (</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/templatefree_isaf_press_releases_ft_train.jsonl"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>template_free_test_target_file_path <span class="op">=</span> (</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"../data/templatefree_isaf_press_releases_ft_test.jsonl"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_data_to_jsonl(df: pd.DataFrame, target_file_path: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    events: List[IsafEvent] <span class="op">=</span> []</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">list</span>(df.iterrows()):</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        event_types <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            eventtype.strip().lower() <span class="cf">for</span> eventtype <span class="kw">in</span> row[<span class="st">"eventtype"</span>].split(<span class="st">","</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        provinces <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>            province.strip().lower() <span class="cf">for</span> province <span class="kw">in</span> row[<span class="st">"province"</span>].split(<span class="st">","</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        target_groups <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            target_group.strip().lower()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> target_group <span class="kw">in</span> row[<span class="st">"targetgroup"</span>].split(<span class="st">","</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        events.append(</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            IsafEvent(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span>row[<span class="st">"name"</span>],</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span>row[<span class="st">"text"</span>],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                start_date<span class="op">=</span>row[<span class="st">"StartDate"</span>].to_pydatetime().date(),</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                event_type<span class="op">=</span>event_types,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                province<span class="op">=</span>provinces,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                target_group<span class="op">=</span>target_groups,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>                min_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minkilled"</span>]),</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                min_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"mincaptured"</span>]),</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                killq<span class="op">=</span>row[<span class="st">"killq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                captureq<span class="op">=</span>row[<span class="st">"captureq"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                killcaptureraid<span class="op">=</span>row[<span class="st">"killcaptureraid"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                airstrike<span class="op">=</span>row[<span class="st">"airstrike"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                noshotsfired<span class="op">=</span>row[<span class="st">"noshotsfired"</span>] <span class="op">==</span> <span class="st">"true"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                min_leaders_killed<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderskilled"</span>]),</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                min_leaders_captured<span class="op">=</span><span class="bu">int</span>(row[<span class="st">"minleaderscaptured"</span>]),</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    processed_data <span class="op">=</span> [</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"segments"</span>: [</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"label"</span>: <span class="va">False</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text"</span>: <span class="st">"&lt;s&gt;You are an expert at identifying events in a press release. You are precise and always make sure you are correct, drawing inference from the text of the press release. event_types = ['airstrike', 'detention', 'captureandkill', 'insurgentskilled', 'exchangeoffire', 'civiliancasualty'], provinces = ['badakhshan', 'badghis', 'baghlan', 'balkh', 'bamyan', 'day_kundi', 'farah', 'faryab', 'ghazni', 'ghor', 'helmand', 'herat', 'jowzjan', 'kabul', 'kandahar', 'kapisa', 'khost', 'kunar', 'kunduz', 'laghman', 'logar', 'nangarhar', 'nimroz', 'nuristan', 'paktya', 'paktika', 'panjshir', 'parwan', 'samangan', 'sar_e_pul', 'takhar', 'uruzgan', 'wardak', 'zabul'], target_groups = ['taliban', 'haqqani', 'criminals', 'aq', 'hig', 'let', 'imu', 'judq', 'iju', 'hik', 'ttp', 'other']"</span>,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"label"</span>: <span class="va">False</span>, <span class="st">"text"</span>: <span class="ss">f"PRESS RELEASE TEXT: </span><span class="sc">{</span>event<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>},</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"label"</span>: <span class="va">True</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text"</span>: <span class="ss">f"</span><span class="sc">{</span>event<span class="sc">.</span>model_dump_json(exclude<span class="op">=</span>{<span class="st">'text'</span>})<span class="sc">}</span><span class="ss">&lt;/s&gt;"</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> event <span class="kw">in</span> events</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write the processed data to a JSONL file</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    os.makedirs(os.path.dirname(target_file_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(target_file_path, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> processed_data:</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>            f.write(json.dumps(item) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>write_data_to_jsonl(train_df, template_free_train_target_file_path)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>write_data_to_jsonl(test_df, template_free_test_target_file_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And you can now see the difference in the format of the JSONL dataset we’ve constructured:</p>
<div id="cell-18" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(template_free_train_target_file_path, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(f.readline())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"segments"</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">"label"</span>: false, <span style="color: #008000; text-decoration-color: #008000">"text"</span>: <span style="color: #008000; text-decoration-color: #008000">"&lt;s&gt;You are an expert at identifying events in a press release. You are </span>
<span style="color: #008000; text-decoration-color: #008000">precise and always make sure you are correct, drawing inference from the text of the press release. event_types = </span>
<span style="color: #008000; text-decoration-color: #008000">['airstrike', 'detention', 'captureandkill', 'insurgentskilled', 'exchangeoffire', 'civiliancasualty'], provinces =</span>
<span style="color: #008000; text-decoration-color: #008000">['badakhshan', 'badghis', 'baghlan', 'balkh', 'bamyan', 'day_kundi', 'farah', 'faryab', 'ghazni', 'ghor', </span>
<span style="color: #008000; text-decoration-color: #008000">'helmand', 'herat', 'jowzjan', 'kabul', 'kandahar', 'kapisa', 'khost', 'kunar', 'kunduz', 'laghman', 'logar', </span>
<span style="color: #008000; text-decoration-color: #008000">'nangarhar', 'nimroz', 'nuristan', 'paktya', 'paktika', 'panjshir', 'parwan', 'samangan', 'sar_e_pul', 'takhar', </span>
<span style="color: #008000; text-decoration-color: #008000">'uruzgan', 'wardak', 'zabul'], target_groups = ['taliban', 'haqqani', 'criminals', 'aq', 'hig', 'let', 'imu', </span>
<span style="color: #008000; text-decoration-color: #008000">'judq', 'iju', 'hik', 'ttp', 'other']"</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">}</span><span style="color: #000000; text-decoration-color: #000000">, </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"label"</span><span style="color: #000000; text-decoration-color: #000000">: false, </span><span style="color: #008000; text-decoration-color: #008000">"text"</span><span style="color: #000000; text-decoration-color: #000000">: </span><span style="color: #008000; text-decoration-color: #008000">"PRESS RELEASE TEXT: ISAF Joint Command Evening </span>
<span style="color: #008000; text-decoration-color: #008000">Operational Update Feb. 19, 2011\nISAF Joint Command - Afghanistan\u20282011-02-S-143\u2028For Immediate Release </span>
<span style="color: #008000; text-decoration-color: #008000">\u2028\u2028KABUL, Afghanistan (Feb. 19)\u2028\u2028ISAF service members at a compound in Sangin district, Helmand </span>
<span style="color: #008000; text-decoration-color: #008000">province observed numerous insurgents north and south of their position talking on radios today. After gaining </span>
<span style="color: #008000; text-decoration-color: #008000">positive identification of the insurgent positions, the coalition troops engaged, killing several insurgents. </span>
<span style="color: #008000; text-decoration-color: #008000">Later, the ISAF troops observed more insurgents positioning in the area with weapons. After positive </span>
<span style="color: #008000; text-decoration-color: #008000">identification, coalition forces continued firing on the various insurgent positions, resulting in several more </span>
<span style="color: #008000; text-decoration-color: #008000">insurgents being killed."</span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">}</span><span style="color: #000000; text-decoration-color: #000000">, </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"label"</span><span style="color: #000000; text-decoration-color: #000000">: true, </span><span style="color: #008000; text-decoration-color: #008000">"text"</span><span style="color: #000000; text-decoration-color: #000000">: </span><span style="color: #008000; text-decoration-color: #008000">"{\"name\":\"Several insurgents killed in </span>
<span style="color: #008000; text-decoration-color: #008000">Helmand\",\"start_date\":\"2011-02-18\",\"event_type\":[\"insurgentskilled\"],\"province\":[\"helmand\"],\"target_g</span>
<span style="color: #008000; text-decoration-color: #008000">roup\":[\"\"],\"min_killed\":6,\"min_captured\":0,\"killq\":true,\"captureq\":false,\"killcaptureraid\":false,\"air</span>
<span style="color: #008000; text-decoration-color: #008000">strike\":false,\"noshotsfired\":false,\"min_leaders_killed\":0,\"min_leaders_captured\":0}&lt;/s&gt;"</span><span style="font-weight: bold">}]}</span>

</pre>
</div>
</div>
</section>
</section>
<section id="finetuning-our-model" class="level1">
<h1>Finetuning our model</h1>
<p>With our datasets ready, finetuning our model is a simple matter of running the following two commands:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess the data ahead of training</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="va">CUDA_VISIBLE_DEVICES</span><span class="op">=</span><span class="st">""</span> <span class="ex">python</span> <span class="at">-m</span> axolotl.cli.preprocess configs/tiny-llama/lora.yml</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># train the model</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">accelerate</span> launch <span class="at">-m</span> axolotl.cli.train configs/tiny-llama/lora.yml</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>axolotl</code> handles everything else. You’ll note that we’re using a pre-prepared config file which is quite long but I’m basically using a default config with only a few changes. We can use <a href="https://github.com/sharkdp/bat"><code>bat</code></a> to view the config file:</p>
<div id="cell-20" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>bat <span class="op">/</span>home<span class="op">/</span>strickvl<span class="op">/</span>coding<span class="op">/</span>isafpr_finetune<span class="op">/</span>configs<span class="op">/</span>tiny<span class="op">-</span>llama<span class="op">/</span>lora.yml</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span style="color:rgb(68,68,68)">───────┬────────────────────────────────────────────────────────────────────────</span>

       <span style="color:rgb(68,68,68)">│ </span>File: <span class="ansi-bold">/home/strickvl/coding/isafpr_finetune/configs/tiny-llama/lora.yml</span>

<span style="color:rgb(68,68,68)">───────┼────────────────────────────────────────────────────────────────────────</span>

<span style="color:rgb(68,68,68)">   1</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">base_model</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">TinyLlama/TinyLlama-1.1B-intermediate-step-1431k-3T</span>

<span style="color:rgb(68,68,68)">   2</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">model_type</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">LlamaForCausalLM</span>

<span style="color:rgb(68,68,68)">   3</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">tokenizer_type</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">LlamaTokenizer</span>

<span style="color:rgb(68,68,68)">   4</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">   5</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">load_in_8bit</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">   6</span> <span class="ansi-green-fg">+</span> <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(108,108,108)">#</span><span style="color:rgb(108,108,108)"> I'm training on 4090 GPUs</span>

<span style="color:rgb(68,68,68)">   7</span> <span class="ansi-green-fg">+</span> <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(108,108,108)">#</span><span style="color:rgb(108,108,108)"> so I'm using 4-bit precision to save on memory</span>

<span style="color:rgb(68,68,68)">   8</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">load_in_4bit</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">   9</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">strict</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">  10</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  11</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">data_seed</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">42</span>

<span style="color:rgb(68,68,68)">  12</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">seed</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">42</span>

<span style="color:rgb(68,68,68)">  13</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  14</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">datasets</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  15</span> <span class="ansi-yellow-fg">~</span> <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,255,255)">  </span><span style="color:rgb(255,255,255)">-</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(255,95,95)">path</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">data/templatefree_isaf_press_releases_ft_train.jsonl</span>

<span style="color:rgb(68,68,68)">  16</span> <span class="ansi-yellow-fg">~</span> <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,255,255)">    </span><span style="color:rgb(255,95,95)">type</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">input_output</span>

<span style="color:rgb(68,68,68)">  17</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">dataset_prepared_path</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  18</span> <span class="ansi-yellow-fg">~</span> <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">val_set_size</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">0</span><span style="color:rgb(175,135,255)">.</span><span style="color:rgb(175,135,255)">1</span>

<span style="color:rgb(68,68,68)">  19</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">output_dir</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">./outputs/tiny-llama/lora-out</span>

<span style="color:rgb(68,68,68)">  20</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">hub_model_id</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">strickvl/isafpr-tiny-llama-lora</span>

<span style="color:rgb(68,68,68)">  21</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  22</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">sequence_len</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">4096</span>

<span style="color:rgb(68,68,68)">  23</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">sample_packing</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">  24</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">eval_sample_packing</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">  25</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">pad_to_sequence_len</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">  26</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  27</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">adapter</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">lora</span>

<span style="color:rgb(68,68,68)">  28</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_model_dir</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  29</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_r</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">32</span>

<span style="color:rgb(68,68,68)">  30</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_alpha</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">16</span>

<span style="color:rgb(68,68,68)">  31</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_dropout</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">0</span><span style="color:rgb(175,135,255)">.</span><span style="color:rgb(175,135,255)">05</span>

<span style="color:rgb(68,68,68)">  32</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_target_linear</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">  33</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lora_fan_in_fan_out</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  34</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  35</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">wandb_project</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">isaf_pr_ft</span>

<span style="color:rgb(68,68,68)">  36</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">wandb_entity</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">strickvl</span>

<span style="color:rgb(68,68,68)">  37</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">wandb_watch</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  38</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">wandb_name</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  39</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">wandb_log_model</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  40</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  41</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">gradient_accumulation_steps</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">4</span>

<span style="color:rgb(68,68,68)">  42</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">micro_batch_size</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">2</span>

<span style="color:rgb(68,68,68)">  43</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">num_epochs</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">4</span>

<span style="color:rgb(68,68,68)">  44</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">optimizer</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">adamw_bnb_8bit</span>

<span style="color:rgb(68,68,68)">  45</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">lr_scheduler</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">cosine</span>

<span style="color:rgb(68,68,68)">  46</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">learning_rate</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">0</span><span style="color:rgb(175,135,255)">.</span><span style="color:rgb(175,135,255)">0002</span>

<span style="color:rgb(68,68,68)">  47</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  48</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">train_on_inputs</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">  49</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">group_by_length</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">  50</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">bf16</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(215,215,135)">auto</span>

<span style="color:rgb(68,68,68)">  51</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">fp16</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  52</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">tf32</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">false</span>

<span style="color:rgb(68,68,68)">  53</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  54</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">gradient_checkpointing</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">  55</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">early_stopping_patience</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  56</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">resume_from_checkpoint</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  57</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">local_rank</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  58</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">logging_steps</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">1</span>

<span style="color:rgb(68,68,68)">  59</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">xformers_attention</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  60</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">flash_attention</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">true</span>

<span style="color:rgb(68,68,68)">  61</span>   <span style="color:rgb(68,68,68)">│</span> 

<span style="color:rgb(68,68,68)">  62</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">warmup_steps</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">10</span>

<span style="color:rgb(68,68,68)">  63</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">evals_per_epoch</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">4</span>

<span style="color:rgb(68,68,68)">  64</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">saves_per_epoch</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">1</span>

<span style="color:rgb(68,68,68)">  65</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">debug</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  66</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">deepspeed</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  67</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">weight_decay</span><span style="color:rgb(255,255,255)">:</span><span style="color:rgb(255,255,255)"> </span><span style="color:rgb(175,135,255)">0</span><span style="color:rgb(175,135,255)">.</span><span style="color:rgb(175,135,255)">0</span>

<span style="color:rgb(68,68,68)">  68</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">fsdp</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  69</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">fsdp_config</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">  70</span>   <span style="color:rgb(68,68,68)">│</span> <span style="color:rgb(255,95,95)">special_tokens</span><span style="color:rgb(255,255,255)">:</span>

<span style="color:rgb(68,68,68)">───────┴────────────────────────────────────────────────────────────────────────</span>
</pre>
</div>
</div>
</div>
<p>You can check out some of the trainings I did with the following links:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">Name</th>
<th style="text-align: center;">Config</th>
<th style="text-align: center;">Model</th>
<th style="text-align: center;">Wandb Report</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Tiny-Llama (Template Free)</td>
<td style="text-align: center;"><a href="https://github.com/strickvl/isafpr_finetune/blob/main/configs/tiny-llama/lora-templatefree.yml">link</a></td>
<td style="text-align: center;"><a href="https://huggingface.co/strickvl/isafpr-tiny-llama-lora-templatefree">link</a></td>
<td style="text-align: center;"><a href="https://wandb.ai/strickvl/isaf_pr_ft/runs/clzgrvww">link</a></td>
</tr>
<tr class="even">
<td style="text-align: left;">Tiny-Llama (ShareGPT)</td>
<td style="text-align: center;"><a href="https://github.com/strickvl/isafpr_finetune/blob/main/configs/tiny-llama/lora-sharegpt.yml">link</a></td>
<td style="text-align: center;"><a href="https://huggingface.co/strickvl/isafpr-tiny-llama-lora-sharegpt">link</a></td>
<td style="text-align: center;"><a href="https://wandb.ai/strickvl/isaf_pr_ft/runs/d5von2yp">link</a></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Llama-3 (Template Free)</td>
<td style="text-align: center;"><a href="https://github.com/strickvl/isafpr_finetune/blob/main/configs/llama-3/lora-templatefree.yml">link</a></td>
<td style="text-align: center;"><a href="https://huggingface.co/strickvl/isafpr-llama3-lora-templatefree">link</a></td>
<td style="text-align: center;"><a href="https://wandb.ai/strickvl/isaf_pr_ft/runs/pm4obu3k">link</a></td>
</tr>
<tr class="even">
<td style="text-align: left;">Mistral (Template Free)</td>
<td style="text-align: center;"><a href="https://github.com/strickvl/isafpr_finetune/blob/main/configs/mistral/lora-templatefree.yml">link</a></td>
<td style="text-align: center;"><a href="https://huggingface.co/strickvl/isafpr-mistral-lora-templatefree">link</a></td>
<td style="text-align: center;"><a href="https://wandb.ai/strickvl/isaf_pr_ft/runs/rzo0sad4">link</a></td>
</tr>
</tbody>
</table>
<p>Now that we have 4 models, we can try some out to see how they fare with some data they haven’t yet seen (from the test set). I used the code from <a href="https://github.com/parlance-labs/ftcourse/blob/master/06_sanity_check.ipynb">Hamel’s Sanity Check notebook</a> to generate some predictions and evaluate them:</p>
<div id="cell-22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Union</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peft <span class="im">import</span> AutoPeftModelForCausalLM</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prompt(press_release):</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""You are an expert at identifying events in a press release. You are precise and always make sure you are correct, drawing inference from the text of the press release. event_types = ['airstrike', 'detention', 'captureandkill', 'insurgentskilled', 'exchangeoffire', 'civiliancasualty'], provinces = ['badakhshan', 'badghis', 'baghlan', 'balkh', 'bamyan', 'day_kundi', 'farah', 'faryab', 'ghazni', 'ghor', 'helmand', 'herat', 'jowzjan', 'kabul', 'kandahar', 'kapisa', 'khost', 'kunar', 'kunduz', 'laghman', 'logar', 'nangarhar', 'nimroz', 'nuristan', 'paktya', 'paktika', 'panjshir', 'parwan', 'samangan', 'sar_e_pul', 'takhar', 'uruzgan', 'wardak', 'zabul'], target_groups = ['taliban', 'haqqani', 'criminals', 'aq', 'hig', 'let', 'imu', 'judq', 'iju', 'hik', 'ttp', 'other']</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="ss">### Instruction:</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="ss">PRESS RELEASE TEXT: "</span><span class="sc">{</span>press_release<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="ss">### Response:</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prompt_tok(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    model: AutoPeftModelForCausalLM,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    tokenizer: AutoTokenizer,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    press_release: <span class="bu">str</span>,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    return_ids: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Union[<span class="bu">str</span>, torch.Tensor]:</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    _p <span class="op">=</span> prompt(press_release)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    input_ids <span class="op">=</span> tokenizer(_p, return_tensors<span class="op">=</span><span class="st">"pt"</span>, truncation<span class="op">=</span><span class="va">True</span>).input_ids.cuda()</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    out_ids <span class="op">=</span> model.generate(input_ids<span class="op">=</span>input_ids, max_new_tokens<span class="op">=</span><span class="dv">5000</span>, do_sample<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    ids <span class="op">=</span> out_ids.detach().cpu().numpy()</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> return_ids:</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out_ids</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tokenizer.batch_decode(ids, skip_special_tokens<span class="op">=</span><span class="va">True</span>)[<span class="dv">0</span>][<span class="bu">len</span>(_p) :]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-23" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>tinyllama_templatefree_model_id <span class="op">=</span> <span class="st">"strickvl/isafpr-tiny-llama-lora-templatefree"</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoPeftModelForCausalLM.from_pretrained(tinyllama_templatefree_model_id).cuda()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(tinyllama_templatefree_model_id)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>tokenizer.pad_token <span class="op">=</span> tokenizer.eos_token</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>press_release_sample1 <span class="op">=</span> <span class="st">"""2011-11-S-011 ISAF Joint Command - Afghanistan For Immediate Release KABUL, Afghanistan (Nov. 7, 2011) — A combined Afghan and coalition security force conducted an operation in search of a Haqqani facilitator in Argo district, Badakshan province. The facilitator coordinates suicide attacks with other insurgent leaders in the area. During the operation, a local national male failed to comply with repeated verbal warnings and displayed hostile intent toward the security force. The security force engaged the individual, resulting in his death. The security force confiscated a shotgun and intelligence linking the local national to the Haqqani network. The security force also detained two suspected insurgents during the operation."""</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> prompt_tok(model, tokenizer, press_release_sample1)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(out)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>out_dict <span class="op">=</span> json.loads(out)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(out_dict)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Asking to truncate to max_length but no maximum length is provided and the model has no predefined maximum length. Default to no truncation.</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">"name"</span>:<span style="color: #008000; text-decoration-color: #008000">"2011-11-07-airstrike"</span>,<span style="color: #008000; text-decoration-color: #008000">"start_date"</span>:<span style="color: #008000; text-decoration-color: #008000">"2011-11-07"</span>,<span style="color: #008000; text-decoration-color: #008000">"event_type"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">"airstrike"</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"province"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">"badakhshan"</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"targ</span>
<span style="color: #008000; text-decoration-color: #008000">et_group"</span>:<span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">"haqqani"</span><span style="font-weight: bold">]</span>,<span style="color: #008000; text-decoration-color: #008000">"min_killed"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,<span style="color: #008000; text-decoration-color: #008000">"min_captured"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,<span style="color: #008000; text-decoration-color: #008000">"killq"</span>:true,<span style="color: #008000; text-decoration-color: #008000">"captureq"</span>:true,<span style="color: #008000; text-decoration-color: #008000">"killcaptureraid"</span>:true,<span style="color: #008000; text-decoration-color: #008000">"airstrik</span>
<span style="color: #008000; text-decoration-color: #008000">e"</span>:true,<span style="color: #008000; text-decoration-color: #008000">"noshotsfired"</span>:false,<span style="color: #008000; text-decoration-color: #008000">"min_leaders_killed"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,<span style="color: #008000; text-decoration-color: #008000">"min_leaders_captured"</span>:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'2011-11-07-airstrike'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'start_date'</span>: <span style="color: #008000; text-decoration-color: #008000">'2011-11-07'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'event_type'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'airstrike'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'province'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'badakhshan'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'target_group'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'haqqani'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'min_killed'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
    <span style="color: #008000; text-decoration-color: #008000">'min_captured'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #008000; text-decoration-color: #008000">'killq'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'captureq'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'killcaptureraid'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'airstrike'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'noshotsfired'</span>: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #008000; text-decoration-color: #008000">'min_leaders_killed'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #008000; text-decoration-color: #008000">'min_leaders_captured'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>The model has certainly learned to output JSON, and it’s done an <em>ok</em> job at parsing the contents of the text, but it has also made errors. It’s said that this was an airstrike whereas no airstrike is mentioned in the text.</p>
<p>This is only a finetune of <a href="https://github.com/jzhang38/TinyLlama">Tiny-Llama</a>, a much smaller version of a Llama model (with v2 architecture). Let’s maybe check out how our Mistral finetune did in comparison:</p>
<div id="cell-25" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mistral_templatefree_model_id <span class="op">=</span> <span class="st">"strickvl/isafpr-mistral-lora-templatefree"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>mistral_model <span class="op">=</span> AutoPeftModelForCausalLM.from_pretrained(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    mistral_templatefree_model_id</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>).cuda()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>mistral_tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(mistral_templatefree_model_id)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>mistral_tokenizer.pad_token <span class="op">=</span> mistral_tokenizer.eos_token</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>mistral_out <span class="op">=</span> prompt_tok(mistral_model, mistral_tokenizer, press_release_sample1)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mistral_out)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>mistral_out_dict <span class="op">=</span> json.loads(mistral_out)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mistral_out_dict)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">'name'</span><span class="fu">:</span> <span class="er">'</span><span class="dv">1</span><span class="er">'</span><span class="fu">,</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="er">'start_date'</span><span class="fu">:</span> <span class="er">'</span><span class="dv">2011-11</span><span class="er">-07'</span><span class="fu">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">'event_type'</span><span class="fu">:</span> <span class="ot">[</span><span class="er">'captureandkill'</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="er">'province'</span><span class="fu">:</span> <span class="ot">[</span><span class="er">'badakhshan'</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">'target_group'</span><span class="fu">:</span> <span class="ot">[</span><span class="er">'haqqani'</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="er">'min_killed'</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="er">'min_captured'</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">'killq'</span><span class="fu">:</span> <span class="er">True</span><span class="fu">,</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">'captureq'</span><span class="fu">:</span> <span class="er">True</span><span class="fu">,</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="er">'killcaptureraid'</span><span class="fu">:</span> <span class="er">True</span><span class="fu">,</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="er">'airstrike'</span><span class="fu">:</span> <span class="er">False</span><span class="fu">,</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="er">'noshotsfired'</span><span class="fu">:</span> <span class="er">False</span><span class="fu">,</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">'min_leaders_killed'</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="er">'min_leaders_captured'</span><span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>I actually had to cheat a bit to get this output. I was getting an out-of-memory (OOM) error when trying to run the inference locally, so I ran the inference using Modal’s compute platform. You can see the script where I ran the one-off inference <a href="https://github.com/strickvl/isafpr_finetune/blob/main/notebooks/sanity_check.py">here</a>. Note that I had to pass in my Hugging Face write token ahead of running the script since Mistral is a gated model. (So the final command was <code>HF_TOKEN="hf_MY_TOKEN_VALUE_WENT_HERE" modal run notebooks/sanity_check.py</code>)</p>
<p>The output it produced, however, is pretty spot on. Actually I noticed that it outperformed the original data since it was able to correctly identify the event type as <code>captureandkill</code> and specify the boolean <code>killcaptureraid</code> as <code>True</code> even though in the ground truth dataset it seems I mislabelled the data and stated that the <code>killcaptureraid</code> value was <code>False</code>.</p>
<p>One thing you might also have noticed is that the <code>name</code> attribute was predicted as being <code>1</code>. Actually, this is not really a problem. When I was labelling the dataset there were sometimes press releases that I needed to split up into separate reports, so I’d give them a numerical name where these were split up. The name is really just a summary of the event, but there are a non-trivial number of events which have numbers as their <code>name</code>, so it’s probably not even a useful field to be training on or trying to predict. Rather, if this was really necessary I could train a model to summarise the content as a headline, but for my specific use case I’m not sure it’s even useful to have this information at all.</p>
<p>I tried getting my Llama3 model to make its predictions, but all I got out was an endless stream of JSON content.</p>
<p><img src="images/llama3-inference.png" class="img-fluid"></p>
<p>I suspect it has something to do with the presence or absence of an <code>&lt;s&gt;</code> tag, which I was using for EOS or ‘end of stream’. I recall there were some error messages during training around these lines, so potentially I’ll want to look into that. I also ran into the same problem as with the Mistral model, i.e having to run it on Modal, and was only able to make it work by specifying a different datatype when loading the model:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoPeftModelForCausalLM.from_pretrained(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>        model_id,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        torch_dtype<span class="op">=</span>torch.bfloat16,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        device_map<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    ).cuda()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Thanks to <a href="https://drchrislevy.github.io/">Chris Levy</a> over on the course forum for suggesting this approach. While this works for getting it to run on Modal, I still am looking for a way to get my Mistral and Llama3 models to run locally, so I’ll probably have to investigate how to optimise the model’s memory usage further.</p>
</section>
<section id="next-steps" class="level1">
<h1>Next Steps</h1>
<p>I’m pretty happy with this set of experiments. It was exciting to see that it’s relatively quick to do experiments with finetuning LLMs: a finetune of Llama3 or Mistral over four epochs only took about 35 minutes on my local machine.</p>
<p>Some obvious next steps for this project are:</p>
<ol type="1">
<li>Figure out the model loading issue mentioned at the end of this post: how to load my models locally and what are the tradeoffs of whatever approaches are possible?</li>
<li>Get more deliberate about adding in some manual evaluations: figure out some examples where I’m deliberately testing some known edge cases and hard-coded outputs. This feels like something that ought to be done sooner than later.</li>
<li>Run the evaluations I had for GPT-4 in the previous blog using my new model(s). Let’s see how well my finetuned models do in comparison.</li>
<li>Run training jobs on all the different platforms where we have course credits in order to get a sense for hwo they work. I’ve only tried out Modal so far, and not even for training, just inference.</li>
<li>Pick one of the base models and try some hyperparameter tuning to see which combination of parameters and config values gives the best performance.</li>
<li>Think about model deployment for whichever candidate I choose as being the best, then run some benchmarking / tests to see how well it performs and whether we can ever compete with the price point of something like GPT-4 (esp when we factor in the accuracy scores across my evaluations).</li>
</ol>
<p>Having written these down, the order in which I wrote them seems like a sensible way to keep going. So my next step will be to read up on the model loading a bit and to try out some possible solutions for loading my models locally.</p>
<p>I’ll also add one personal note on the experience so far. I’m really enjoying the experience of being very hands-on. There are some parts of what I did so far that perhaps require a bit of experience to quickly move past some boring work (converting data from one format to the other and so on), but for the most part I’ve found the work of finetuning models to be really accessible to someone without much technical background. Even the conversion of datasets and construction of templates is all relatively straightforward and (beyond needing to have the intuition to <em>know</em> that that’s a thing you have to do) you could accomplish most of it using Claude or GPT-4 without even any technical background at all.</p>
<p>It’s also quite empowering to see all these vistas open up before me, especially the ones enabled by being able to finetune these models on my local machine. I’m really excited about the next experiments and stages of this project to come, in particular how much there is to learn!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/alexstrick\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="strickvl/mlops-dot-systems" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->




</body></html>