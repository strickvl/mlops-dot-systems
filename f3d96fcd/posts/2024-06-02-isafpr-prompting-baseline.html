<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Strick van Linschoten">
<meta name="dcterms.date" content="2024-06-02">
<meta name="description" content="I used Instructor to understand how well LLMs are at extracting data from the ISAF Press Releases dataset. They did pretty well, but not across the board.">

<title>Alex Strick van Linschoten - Structured Data Extraction for ISAF Press Releases with Instructor</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script defer="" data-domain="mlops.systems" src="https://plausible.io/js/script.js"></script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Alex Strick van Linschoten - Structured Data Extraction for ISAF Press Releases with Instructor">
<meta property="og:description" content="I used Instructor to understand how well LLMs are at extracting data from the ISAF Press Releases dataset. They did pretty well, but not across the board.">
<meta property="og:image" content="https://mlops.systems/posts/images/structure-extraction.png">
<meta property="og:site-name" content="Alex Strick van Linschoten">
<meta property="og:image:height" content="500">
<meta property="og:image:width" content="500">
<meta name="twitter:title" content="Alex Strick van Linschoten - Structured Data Extraction for ISAF Press Releases with Instructor">
<meta name="twitter:description" content="I used Instructor to understand how well LLMs are at extracting data from the ISAF Press Releases dataset. They did pretty well, but not across the board.">
<meta name="twitter:image" content="https://mlops.systems/posts/images/structure-extraction.png">
<meta name="twitter:creator" content="@strickvl">
<meta name="twitter:image-height" content="500">
<meta name="twitter:image-width" content="500">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Alex Strick van Linschoten</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../til.html">
 <span class="menu-text">TIL</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/strickvl"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://sigmoid.social/web/@alexstrick"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/strickvl"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://mlops.systems/index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Structured Data Extraction for ISAF Press Releases with Instructor</h1>
                  <div>
        <div class="description">
          I used Instructor to understand how well LLMs are at extracting data from the ISAF Press Releases dataset. They did pretty well, but not across the board.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">nlp</div>
                <div class="quarto-category">afghanistan</div>
                <div class="quarto-category">datalabelling</div>
                <div class="quarto-category">isafpr</div>
                <div class="quarto-category">llms</div>
                <div class="quarto-category">miniproject</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Alex Strick van Linschoten </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 2, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#structured-data-extraction-with-instructor" id="toc-structured-data-extraction-with-instructor" class="nav-link active" data-scroll-target="#structured-data-extraction-with-instructor">Structured data extraction with Instructor</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>I’m currently participating in <a href="https://maven.com/parlance-labs/fine-tuning">the Maven LLM course / conference</a>. Originally focused on finetuning LLMs, it’s since expanded to encompass a wide range of LLM-related topics. I thought I’d try to work through a small project alongside the course to get some practical experience with fine-tuning LLMs.</p>
<p>I previously published a dataset from my time working in Afghanistan: the ISAF Press Releases dataset. (See <a href="https://mlops.systems/posts/2024-03-24-publishing-afghanistan-dataset-huggingface.html">here</a> for a blogpost I wrote describing the dataset in more detail.) Even though it was not really intended as a dataset to be used for any kind of model training, I thought it might serve well to finetune an LLM on top of it. The dataset is made up of press releases from <a href="https://en.wikipedia.org/wiki/International_Security_Assistance_Force">the International Security Assistance Force (ISAF)</a> and I had previously annotated them, extracting out metadata of interest.</p>
<p>Here’s an example:</p>
<blockquote class="blockquote">
<p>“2013-02-21 KABUL, Afghanistan, February 21, 2013 - An Afghan and coalition security force arrested six insurgents during an operation in search of an Islamic Movement of Uzbekistan leader in Kunduz district, Kunduz province, today. The leader is allegedly instrumental in manufacturing, procuring and distributing improvised explosive devices for use in attacks against Afghan and coalition forces in the province. The security force also seized a shotgun as a result of the operation.”</p>
</blockquote>
<p>From this I extracted the following metadata:</p>
<ul>
<li>the date</li>
<li>the type of event (detention)</li>
<li>the province where the even took place (Kunduz)</li>
<li>The city or district where the event took place (Kunduz)</li>
<li>the group that was targeted in the raid (IMU)</li>
<li>the minimum number of people killed (0)</li>
<li>the minimum number of people captured (6)</li>
<li>the phrase used to characterise the number captured (6)</li>
<li>whether anyone was killed or not (no)</li>
<li>whether anyone was captured or not (yes)</li>
<li>whether an airstrike was conducted or not (no)</li>
<li>whether any leaders were arrested or not (no)</li>
</ul>
<p>There were a few other pieces of metadata captured but you probably get the idea. Check out <a href="https://huggingface.co/datasets/strickvl/isafpressreleases">the dataset’s card</a> which gives full details.</p>
<p>There are 4822 such events in the dataset and as you might imagine it took quite a long time to manually annotate all this data. An example like the one above is fairly straightforward but it’s sometimes unclear exactly how many people were involved. Take this press release:</p>
<blockquote class="blockquote">
<p>“2012-12-S-025 KABUL, Afghanistan (Dec.&nbsp;26, 2012) An Afghan- led security force of more than 1,000 Afghan National Security Force soldiers and policemen, concluded a five day coalition-supported operation in Baraki Barak district, Logar province, yesterday. The operation was conducted by the Provincial Response Company Laghman, along with elements of the Afghan Local Police, the Afghan Uniformed Police, and the Afghan National Army. During the operation, the Afghan-led force killed multiple insurgents and detained dozens of suspected insurgents. The security force also seized improvised explosive device materials, suicide vests, weapons, ammunition, and a quantity of illicit drugs.”</p>
</blockquote>
<p>The number of people killed is specified as “multiple” and the number of those captured is specified as “dozens”. So that means a minimum of 3 killed and a minimum of 24 captured. But you have to be reading fairly closely to pick all of this up, and it gets even more complicated when they refer to multiple events in the same press release (and so on).</p>
<p>It occurred to me recently that it might make for an interesting test of an LLM’s ability to extract this data out of the raw text in a structured format. So ideally I’d input the press release and I’d get out a JSON object (or Pydantic or whatever) which populates all the various fields.</p>
<p>I’m lucky in that I’ve already lovingly labeled such a large dataset so I can be really confident in the quality which will allow me to focus on the task of finetuning an LLM to do this task.</p>
<p>So my learning goals from this project are to:</p>
<ul>
<li>get more familiar with the practical flow of finetuning an LLM, particularly given hardware constraints and seeing how much can be done on my local machine vs needing cloud hardware.</li>
<li>understand the best use cases for finetuning LLMs</li>
<li>get some experience with deploying the finetuned LLMs (and seeing how that compares to the popular LLMs available via API (Anthropic / OpenAI etc))</li>
<li>understand the limits of structured data extraction using LLMs</li>
<li>get a sense of the effort needed to finetune LLMs for a focused task like this</li>
<li>see how much can be done with local and open-source LLMs</li>
</ul>
<p>For the project itself, I keep reading (and <a href="https://www.youtube.com/watch?v=kFdfDJ1fQxY">watching</a>) that you can get GPT-4 level performance on specific focused tasks by finetuning LLMs and I wanted to see how much can be done with limited resources (or just how cherry-picked those public examples actually are.)</p>
<p>I have <a href="https://huggingface.co/datasets/strickvl/isafpressreleasescomplete">a ‘complete’ dataset</a> which includes press releases published after I finished working on my report, so ideally I’ll be able to use the model to label the remaining data (if it’s good enough in terms of accuracy). I’d also like to see how the speed of a finetuned model compares to using something like GPT-4.</p>
<p>Let’s try this out with a simple prompt and a single example to see how it performs out of the box! We load the dataset first:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get data from datasets</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tqdm <span class="im">as</span> notebook_tqdm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> load_dataset(<span class="st">"strickvl/isafpressreleases"</span>, split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the dataset to a pandas DataFrame</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(dataset)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first few rows of the DataFrame</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/strickvl/.pyenv/versions/3.10.14/envs/isafpr/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                              name  eventrefnumber  \
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>          Taliban Compound Struck  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>-CA-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">056</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>   Militants Detained in Kandahar  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>-CA-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">056</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>      Militants Detained in Khost  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-CA–<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">057</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>     Militants Detained in Wardak  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-CA–<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">057</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>  Insurgents Detained in Kandahar  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-CA-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">058</span>   

                                                text  StartDate  eventtype  \
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>  Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>: Taliban Compound Struck\n\nNEWS RELEAS<span style="color: #808000; text-decoration-color: #808000">...</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>  airstrike   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>  Militants Detained in Kandahar\nNEWS RELEASE I<span style="color: #808000; text-decoration-color: #808000">...</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">02</span>  detention   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>  Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>: Militants Detained in Khwost\nNEWS REL<span style="color: #808000; text-decoration-color: #808000">...</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">02</span>  detention   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>  Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>: Militants Detained in Wardak\n\n\n\nNE<span style="color: #808000; text-decoration-color: #808000">...</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">03</span>  detention   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>  Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>: Insurgents Detained in Kandahar\nISAF <span style="color: #808000; text-decoration-color: #808000">...</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">04</span>  detention   

   province     citydistrict       village targetgroup commander  <span style="color: #808000; text-decoration-color: #808000">...</span>  \
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>     Kunar     Dara-ye Noor                   Taliban            <span style="color: #808000; text-decoration-color: #808000">...</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>  Kandahar    Kandahar City                   Taliban            <span style="color: #808000; text-decoration-color: #808000">...</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>     Khost  Sabari district      Khatekah     Taliban            <span style="color: #808000; text-decoration-color: #808000">...</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>    Wardak       Sayyedabad    Jamad Khel     Taliban            <span style="color: #808000; text-decoration-color: #808000">...</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>  Kandahar        Arghandab  Nurayo Kariz     Taliban            <span style="color: #808000; text-decoration-color: #808000">...</span>   

  airstrike noshotsfired dataprocessed flagged glossarymeta minleaderskilled  \
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>      true        false          true   false        false                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>     false         true          true   false        false                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>     false         true          true   false        false                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>     false         true          true   false        false                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>     false         true          true   false        false                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   

  minfacilitatorskilled minleaderscaptured minfacilitatorscaptured leaderq  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   false  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   false  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>   false  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>   false  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>   false  

<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span> rows x <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span> columns<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<p>We can take a peek at the columns in the dataset:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>Index(['name', 'eventrefnumber', 'text', 'StartDate', 'eventtype', 'province',
       'citydistrict', 'village', 'targetgroup', 'commander', 'position',
       'minkilled', 'mincaptured', 'capturedcharacterisation',
       'killedcharacterisation', 'killq', 'captureq', 'killcaptureraid',
       'airstrike', 'noshotsfired', 'dataprocessed', 'flagged', 'glossarymeta',
       'minleaderskilled', 'minfacilitatorskilled', 'minleaderscaptured',
       'minfacilitatorscaptured', 'leaderq'],
      dtype='object')</code></pre>
</div>
</div>
<p>If we look at the options for the ‘eventtype’ column, you’ll see that we have some single-word event types at the top, but also some semi-colon-separated event types. We’ll need to handle these a bit differently when we get to finetuning but perhaps let’s ignore that for now.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>eventtype_options <span class="op">=</span> df[<span class="st">"eventtype"</span>].unique().tolist()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(eventtype_options)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #008000; text-decoration-color: #008000">'airstrike'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'detention'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'captureandkill'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'insurgentskilled'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'exchangeoffire'</span>,
    <span style="color: #008000; text-decoration-color: #008000">''</span>,
    <span style="color: #008000; text-decoration-color: #008000">'civiliancasualty'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'2010-07-CA-124'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'insurgentskilled;civiliancasualty'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'airstrike;detention'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'detention;airstrike'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'civiliancasualty;airstrike'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'airstrike;civiliancasualty'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'insurgentskilled;detention'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'detention;insurgentskilled'</span>
<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<p>We have everything we need to set up the task and the data structures that will be filled by our LLM. Let’s start with the event type where we just create an enum to store the options:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EventType(<span class="bu">str</span>, Enum):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    airstrike <span class="op">=</span> <span class="st">"airstrike"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    detention <span class="op">=</span> <span class="st">"detention"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    captureandkill <span class="op">=</span> <span class="st">"captureandkill"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    insurgentskilled <span class="op">=</span> <span class="st">"insurgentskilled"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    exchangeoffire <span class="op">=</span> <span class="st">"exchangeoffire"</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    civiliancasualty <span class="op">=</span> <span class="st">"civiliancasualty"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can create a similar enum to store the provinces in Afghanistan:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Province(<span class="bu">str</span>, Enum):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    badakhshan <span class="op">=</span> <span class="st">"badakhshan"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    badghis <span class="op">=</span> <span class="st">"badghis"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    baghlan <span class="op">=</span> <span class="st">"baghlan"</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    balkh <span class="op">=</span> <span class="st">"balkh"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    bamyan <span class="op">=</span> <span class="st">"bamyan"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    day_kundi <span class="op">=</span> <span class="st">"day_kundi"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    farah <span class="op">=</span> <span class="st">"farah"</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    faryab <span class="op">=</span> <span class="st">"faryab"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    ghazni <span class="op">=</span> <span class="st">"ghazni"</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    ghor <span class="op">=</span> <span class="st">"ghor"</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    helmand <span class="op">=</span> <span class="st">"helmand"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    herat <span class="op">=</span> <span class="st">"herat"</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    jawzjan <span class="op">=</span> <span class="st">"jawzjan"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    kabul <span class="op">=</span> <span class="st">"kabul"</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    kandahar <span class="op">=</span> <span class="st">"kandahar"</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    kapisa <span class="op">=</span> <span class="st">"kapisa"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    khost <span class="op">=</span> <span class="st">"khost"</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    kunar <span class="op">=</span> <span class="st">"kunar"</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    kunduz <span class="op">=</span> <span class="st">"kunduz"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    laghman <span class="op">=</span> <span class="st">"laghman"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    logar <span class="op">=</span> <span class="st">"logar"</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    nangarhar <span class="op">=</span> <span class="st">"nangarhar"</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    nimroz <span class="op">=</span> <span class="st">"nimroz"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    nuristan <span class="op">=</span> <span class="st">"nuristan"</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    paktia <span class="op">=</span> <span class="st">"paktia"</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    paktika <span class="op">=</span> <span class="st">"paktika"</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    panjshir <span class="op">=</span> <span class="st">"panjshir"</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    parwan <span class="op">=</span> <span class="st">"parwan"</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    samangan <span class="op">=</span> <span class="st">"samangan"</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    sar_e_pol <span class="op">=</span> <span class="st">"sar_e_pol"</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    takhar <span class="op">=</span> <span class="st">"takhar"</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    uruzgan <span class="op">=</span> <span class="st">"uruzgan"</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    wardak <span class="op">=</span> <span class="st">"wardak"</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    zabul <span class="op">=</span> <span class="st">"zabul"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we can create an <code>IsafEvent</code> which is a Pydantic model where we’ll store all the various pieces of data we’re interested in. We include descriptions of the different fields which will help our LLM to understand the data it’s working with.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IsafEvent(BaseModel):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"A title or name for the event"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    start_date: date <span class="op">=</span> Field(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The start date of the event in YYYY-MM-DD format"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    end_date: date <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The end date of the event in YYYY-MM-DD format"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    event_type: EventType <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The event type"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    province: Province <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"The province in which the event occurred"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    target_group: <span class="bu">str</span> <span class="op">=</span> Field(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The group that was targetted during the event."</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    min_killed: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of people killed during the event"</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    min_captured: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of people captured during the event"</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    killq: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether someone was killed or not during the event"</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    captureq: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether someone was captured or not during the event"</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    killcaptureraid: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether the event was a so-called 'kill-capture raid'."</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    airstrike: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether an airstrike was used during the event"</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    noshotsfired: <span class="bu">bool</span> <span class="op">=</span> Field(</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"Whether no shots were fired during the event"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    min_leaders_killed: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of leaders killed during the event"</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    min_leaders_captured: <span class="bu">int</span> <span class="op">=</span> Field(</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">"The minimum number of leaders captured during the event"</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Config:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        arbitrary_types_allowed <span class="op">=</span> <span class="va">True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s get a sample article to work with:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>article_id <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>article_text <span class="op">=</span> df[<span class="st">"text"</span>][article_id]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(article_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>: Haqqani Facilitator Detained in Khowst; Security Discussed in Farah
NEWS RELEASE ISAF Joint Command - Afghanistan   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>-CA-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">065</span> For Immediate Release  KABUL, Afghanistan <span style="font-weight: bold">(</span>Dec. <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span> - An
Afghan-international security force detained a couple of militants in Khowst province today, one of whom was a 
sought-after Haqqani facilitator.&nbsp; The facilitator is responsible for the shipment and distribution of weapons to 
other militant elements in the area.
 The joint security force searched a compound near the village of Badal Kalay in the Nader Shakhot district where 
intelligence sources indicated the facilitator was located.&nbsp; The facilitator identified himself and surrendered 
without incident.&nbsp; No shots were fired and no one was injured.
</pre>
</div>
</div>
<p>Now we can construct a simple prompt to help guide the LLM to extract the right data:</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ss">The following is a press release issued by ISAF (formerly operating in Afghanistan):</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>article_text<span class="sc">}</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ss">Please extract the following information from the press release:</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- The name of the event</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- The start date of the event</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- The end date of the event</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- The event type</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- The province in which the event occurred</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ss">- The target group of the event</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of people killed during the event</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of people captured during the event</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether someone was killed or not during the event</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether someone was captured or not during the event</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether the event was a so-called 'kill-capture raid'</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether an airstrike was used during the event</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether no shots were fired during the event</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of leaders killed during the event</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of leaders captured during the event</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="structured-data-extraction-with-instructor" class="level2">
<h2 class="anchored" data-anchor-id="structured-data-extraction-with-instructor">Structured data extraction with Instructor</h2>
<p>Now we can use <a href="https://python.useinstructor.com/">Instructor</a> to help ensure that our data is extracted out according to our Pydantic model and just use GPT-3.5 to see how it performs:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> instructor</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># patch the client to add `response_model` to the `create` method</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.patch(OpenAI(), mode<span class="op">=</span>instructor.Mode.MD_JSON)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>openai_resp <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: query,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>IsafEvent,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(openai_resp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani Facilitator Detained in Khowst'</span>,
    <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">end_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">EventType.detention:</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'detention'</span><span style="color: #000000; text-decoration-color: #000000">&gt;,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #808000; text-decoration-color: #808000">province</span><span style="color: #000000; text-decoration-color: #000000">=&lt;Province.khost: </span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">&gt;</span>,
    <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani facilitator'</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
<p>As you can see, GPT-3.5 did pretty well! It was able to extract all the data more or less as I’d have hoped. It was able to determine that “Khowst” province in the article was “Khost” province in the schema, and it correctly determined that two individuals were detained. The only thing where I would have done things differently was to state that a minimum of one leader was captured. In this project I didn’t consider a ‘faciliator’ to be a leader so in the original dataset this would have been a 0:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"minleaderscaptured"</span>][article_id]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>'0'</code></pre>
</div>
</div>
<p>It’s hard for the LLM to have known that we’re taking that approach without having specified it in the prompt, but we can try again, updating the prompt with that rule:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>updated_query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ss">The following is a press release issued by ISAF (formerly operating in Afghanistan):</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="sc">{</span>article_text<span class="sc">}</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ss">Please extract the following information from the press release:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- The name of the event</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- The start date of the event</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- The end date of the event</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- The event type</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- The province in which the event occurred</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="ss">- The target group of the event</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of people killed during the event</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of people captured during the event</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether someone was killed or not during the event</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether someone was captured or not during the event</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether the event was a so-called 'kill-capture raid'</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether an airstrike was used during the event</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- Whether no shots were fired during the event</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of leaders killed during the event</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- The minimum number of leaders captured during the event</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="ss">So-called 'facilitators' aren't considered leaders in this task.</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> instructor</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># patch the client to add `response_model` to the `create` method</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.patch(OpenAI(), mode<span class="op">=</span>instructor.Mode.MD_JSON)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>openai_resp <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: query,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>IsafEvent,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(openai_resp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani Facilitator Detained in Khowst'</span>,
    <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">end_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">EventType.detention:</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'detention'</span><span style="color: #000000; text-decoration-color: #000000">&gt;,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #808000; text-decoration-color: #808000">province</span><span style="color: #000000; text-decoration-color: #000000">=&lt;Province.khost: </span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">&gt;</span>,
    <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani facilitator'</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
<p>Unfortunately it’s still getting it wrong. Let’s try with GPT-4 this time and hope that it’s better at following instructions:</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>openai_resp <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: query,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>IsafEvent,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(openai_resp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani Facilitator Detained in Khowst'</span>,
    <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">end_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">EventType.detention:</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'detention'</span><span style="color: #000000; text-decoration-color: #000000">&gt;,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #808000; text-decoration-color: #808000">province</span><span style="color: #000000; text-decoration-color: #000000">=&lt;Province.khost: </span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">&gt;</span>,
    <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani'</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
<p>Unfortunately we’re still getting the same response. I could fiddle around with the prompt a bit more to get the result I wanted, but you can see that this approach of encoding all these edge cases into the prompt isn’t going to scale very well. It’s also going to overfit a little to the training data and really what we want is a model that can do well at any new articles we pass into it.</p>
<p>Even when we try Claude’s Opus model we get the same result, which tells us that for sure we’d have to amend this in the prompt to fix the problem.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> anthropic <span class="im">import</span> Anthropic</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> instructor</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.from_anthropic(Anthropic())</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># note that client.chat.completions.create will also work</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>claude_opus_resp <span class="op">=</span> client.messages.create(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-3-opus-20240229"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: query,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">4096</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>IsafEvent,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(claude_opus_resp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani Facilitator Detained in Khowst'</span>,
    <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">end_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">EventType.detention:</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'detention'</span><span style="color: #000000; text-decoration-color: #000000">&gt;,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #808000; text-decoration-color: #808000">province</span><span style="color: #000000; text-decoration-color: #000000">=&lt;Province.khost: </span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">&gt;</span>,
    <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani'</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
<p>And again, using Ollama locally with their <code>mixtral</code> model we get the same result:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># enables `response_model` in create call</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> instructor.from_openai(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    OpenAI(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        base_url<span class="op">=</span><span class="st">"http://localhost:11434/v1"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        api_key<span class="op">=</span><span class="st">"ollama"</span>,  <span class="co"># required, but unused</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span>instructor.Mode.JSON,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>mixtral_resp <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"mixtral"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: query,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    response_model<span class="op">=</span>IsafEvent,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mixtral_resp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">IsafEvent</span><span style="font-weight: bold">(</span>
    <span style="color: #808000; text-decoration-color: #808000">name</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani Facilitator Detention in Khowst'</span>,
    <span style="color: #808000; text-decoration-color: #808000">start_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">end_date</span>=<span style="color: #800080; text-decoration-color: #800080; font-weight: bold">datetime</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">.date</span><span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2009</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span><span style="font-weight: bold">)</span>,
    <span style="color: #808000; text-decoration-color: #808000">event_type</span>=<span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">EventType.detention:</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #008000; text-decoration-color: #008000">'detention'</span><span style="color: #000000; text-decoration-color: #000000">&gt;,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #808000; text-decoration-color: #808000">province</span><span style="color: #000000; text-decoration-color: #000000">=&lt;Province.khost: </span><span style="color: #008000; text-decoration-color: #008000">'khost'</span><span style="font-weight: bold">&gt;</span>,
    <span style="color: #808000; text-decoration-color: #808000">target_group</span>=<span style="color: #008000; text-decoration-color: #008000">'Haqqani militants'</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>,
    <span style="color: #808000; text-decoration-color: #808000">killq</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">captureq</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">killcaptureraid</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">airstrike</span>=<span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #808000; text-decoration-color: #808000">noshotsfired</span>=<span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_killed</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
    <span style="color: #808000; text-decoration-color: #808000">min_leaders_captured</span>=<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>
<span style="font-weight: bold">)</span>
</pre>
</div>
</div>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<p>If there’s one thing the Maven conference has done well it’s to emphasise the importance of getting a solid sense of an initial baseline from which you can (measureably) improve. So what I’d like to do next is to make a simple evaluation of the performance of the different models on this task.</p>
<p>Coming up with a score will be interesting as there are multiple pieces of information to compare. Numbers to numbers is an easy comparison, but what happens when it gets the wrong category? Do I subtract a mark from the score, or do I keep scores for all the different attributes? It isn’t clear to me how best to construct this score.</p>
<p>It also occurred to me while writing the above code that when I was doing the annotation I did so in ‘passes’. So I’d read the article and I’d be reading it looking only for the numbers of killed and captured individuals and nothing else. Then I’d reread the article and extract the data and location, and so on with multiple passes. This is to keep me focused on small details as if I tried to make note of everything at a single pass then I’d certainly miss things or get things wrong. So extrapolating out to LLMs (which, to be clear, don’t work like humans when they read text) I’m wondering whether it might make sense to finetune multiple specialised LLMs to be really best in class at extracting one or two data points instead of expecting it to do what I was unable (i.e. extracting everything at a single pass). Obviously it’d be preferable to have a single model, but I’m wondering whether we might push the limits of what an LLM can do at some of the longer or more complex articles. We’ll have to keep that in mind going forward.</p>
<p>The one thing I’ll have to make sure to do before I run the evaluation is to make sure that my data structures are set up to match the original dataset. You’ll remember that above we ignored the fact the <code>eventtype</code> field could have multiple types separated by a semicolon. So I’ll have to make sure that my data structures are set up to handle that. I’ll also improve the descriptions of the fields where possible and try to make the prompt a bit more performant.</p>
<p>In the next blog I’ll show the results of evaluating some of our baseline LLMs (proprietary and open-source) to see how they perform for this task. Once we have that baseline then we can continue to the task of actually finetuning an LLM.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="strickvl/mlops-dot-systems" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>